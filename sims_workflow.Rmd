#---
title: "sims_workflow"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(boot)
library(ggplot2)

#To do

#do sampling as abundance model
#sites/years vary by detection probability
#last occupancy year
#compare with analysis of raw data....simple binomial GLM

```

Simulation parameters

```{r}
#Define basic scenario set-up

#set.seed(2)

#Number of sites in the landscape
NSites <- 50

#Number of species in the regional pool
NSpecies <- 30

#Number of time points
NYears <- 10

#Define occupancy settings

#Define average occupancy of species
#OccProb <- rep(0.3,NSpecies)
lambda <- rep(1, NSpecies)
OccProb <- rnorm(NSpecies,0.3,0.1)#allow for species-level variation
#lambda <- rlnorm(NSpecies,0.1,0.05)#allow for species-level variation

#Define average habitat quality of each site
Scovariate <- rnorm(NSites,0,1)

#Define spatial quality effects
Seffects <- rep(0,NSpecies)
#Seffects <- rnorm(NSpecies,0.05,0.01)#allow for species-level variation

#Define time trend
Tcovariate <- (1:NYears)-mean(1:NYears)

#Define spatial quality effects
Teffects <- rep(0,NSpecies)
#Teffects <- rnorm(NSpecies,0.05,0.01)#allow for species-level variation

#Interaction - between space and time
Ieffects <- rep(0,NSpecies)

#Define sampling effects:

#Number of visits to each site within each year
NVisits <- 5

#Define average detection probability
DetProb <- rep(0.3,NSpecies)
#DetProb <- rnorm(NSpecies,0.3,0.1)#allow for species-level variation

#Assume changes in effort affect all species similarly
#Detection covariates
SiteDetEffects <- rep(0,NSpecies)
YearDetEffects <- rep(0,NSpecies)
IntDetEffects <- rep(0,NSpecies)

#Identify focal species
focalSpecies=1

#model type
#myModel = "basic_odm.txt"
myModel = "basic_odm_Interceptonly.txt"
#myModel = "basic_odm_fixedYear.txt"
#myModel = "basic_odm_fixedYear_LL.txt"
```

Save the parameters and identify simulation run

```{r}

systemTime <- gsub(" ","_", Sys.time(),fixed=TRUE)
systemTime <- gsub(":","-",systemTime)

parameters <- list(DetProb,focalSpecies,Ieffects,IntDetEffects,NSites,
                  NSpecies,NVisits,NYears,OccProb,Scovariate,Seffects,SiteDetEffects,
                  Tcovariate,Teffects,YearDetEffects,myModel)

save(parameters,file=paste0("parameters/parameters",systemTime,".RData"))

```

Load in functions

```{r}

source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/getOccuHistory.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/getRepeatVisits.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/getSpartaFormat.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/getBugsData.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/runModel.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/helperFunctions.R')

```

Create some replicated worlds

```{r, echo=FALSE, results='hide'}

Obs <- replicate(50,getSims(),simplify=FALSE)
getObsSummaries(Obs)

```

Run the basic model

```{r, message=FALSE, warning=FALSE}

out<- lapply(Obs,function(x)getModels(x))
#save(out,file=paste0("output/out_standard",systemTime,".RData"))

```

Compare real and predicted intercept (psi1) and slope (psi change from last to first)

```{r}

checkResults(out)
saveResults(out,type="fixed_interceptonly")
#occurrence simulation (yearEffects model)
#works fine, with zeros on all covariate effects
#works with 0.1 on occupancy and detection time effects
#works with 0.1 on occupancy and detection spatial effects

#abundance simulation
#works with fixed lambda and det prob/intercept only model
#works fine with time trend and FixedYear model


#abundance simulation (yearEffects model)
#with zeros on all covariate effects
#overestimates trend with time effect

#abundance (yearEffects_LL model)
#with time trend, sort of works
#with time trend and spatial effect, sort of works
```

Get summaries over parameters, model types

```{r}

print(modelSummaries <- getModelSummaries(out))

```

Compare the analysis fo raw Data

```{r, message=FALSE, warning=FALSE}

outRaw<- ldply(Obs,function(x)rawdataAnalysis(x))
rawSummaries <- getrawSummaries(outRaw)

```

plot comparison
```{r}

plotComparison(modelSummaries,rawSummaries)
#500/250

```



Atlas scenarios

(a) Scenario_autocorrelation - probability of dependence between sequential visits
- at a proportion of sites
- autocorrelation of order 1 with certain probability

```{r}

source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/scenario_autocorrelation.R')

runSims <- function(propSites=0.5,autoProb=0.5){
  
  #get simulated data
  Obs <- getSims()
  
  #reduce visits in non-atlas years
  Obs_auto <-applyAutocorrelation(Obs,propSites,autoProb)
  
  return(Obs_auto)
  
}

Obs <- replicate(100,runSims(),simplify=FALSE)

#raw data analysis
outRaw<- ldply(Obs,function(x)rawdataAnalysis(x))
rawSummaries <- getrawSummaries(outRaw)

#fit OD models
modelSummary_auto <- lapply(Obs,function(x)getModels(x,type="Autocorrelation",myModel))
modelSummaries <- getModelSummaries(modelSummary_auto)

#Analyse results
plotComparison(modelSummaries,rawSummaries)

```



(b) Pulse in recording - increased visits in one year (atlas year) 

```{r}

source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/scenario_pulsedvisits.R')

runSims <- function(nStandardVisits=5,atlasVisits=10){
  
  #get simulated data
  NVisits=atlasVisits
  Obs <- getSims()
  
  #reduce visits in non-atlas years
  Obs_pulsed <- pulsedVisits(Obs,nStandardVisits)

  #return summary data
  return(Obs_pulsed)
}

Obs <- replicate(100,runSims(),simplify=FALSE)

#raw data analysis
outRaw<- ldply(Obs,function(x)rawdataAnalysis(x))
rawSummaries <- getrawSummaries(outRaw)

#fit OD models
modelSummary_pulsed <- lapply(Obs,function(x)getModels(x,type="Pulsed",myModel))
modelSummaries <- getModelSummaries(modelSummary_pulsed)

#Analyse results
plotComparison(modelSummaries,rawSummaries)


```

(c) Lower quality grid cells less likely to be visited outside of atlas years

```{r}

source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/scenario_pulsedvisits.R')

runSims <- function(lowProb=0.25){

  #get simulated data
  Obs <- getSims()
  
  #reduce visits in non-atlas years
  Obs_spread <- pulsedSpreadVisits(Obs,SCovariate,lowProb)

  #return summary data
  return(Obs_spread)
}

Obs <- replicate(100,runSims(),simplify=FALSE)

#raw data analysis
outRaw<- ldply(Obs,function(x)rawdataAnalysis(x))
rawSummaries <- getrawSummaries(outRaw)

#fit OD models
modelSummary_spread <- lapply(Obs,function(x)getModels(x,type="Spread",myModel))
modelSummaries <- getModelSummaries(modelSummary_spread)

#Analyse results
plotComparison(modelSummaries,rawSummaries)

```

(2) Mismatch between scale of dynamics and observation

```{r}
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/scenario_spatialmismatch.R')

runSims <- function(x){
   Occ <- getOccuHistory(OccProb, spatialbeta=Seffects, interactionbeta=Ieffects, spatialcovariates=Scovariate,temporalbeta=Teffects, temporalcovariates=Tcovariate)
  Obs <- getRepeatVisits(Occ, NVisits, DetProb, SiteDetEffects,YearDetEffects,IntDetEffects, Scovariate,Tcovariate)
 
 
  #apply scenario
 Obs_grouped <- groupSite(NSites=NSites, Obs=Obs)
 Obs_reduced <- reduceVisits(Obs=Obs_grouped)
  
  #with original dataset
  modelData <- getSpartaFormat(Obs,focalSpecies=focalSpecies)
  bugs.data <- getBugsData(modelData)
  modelSummary <- runModel(bugs.data,modelData,focalSpecies)
  modelSummary$Type <- "Standard"
  
  #with fixed dataset
  #modelData_grouped <- getSpartaFormat(Obs=Obs_grouped,focalSpecies=focalSpecies)
  #bugs.data_grouped <- getBugsData(modelData=modelData_grouped)
  #modelSummary_grouped <- runModel(bugs.data=bugs.data_grouped,modelData=modelData_grouped,focalSpecies)
  #modelSummary_grouped$Type <- "grouped"
  
  #with fixed dataset
  modelData_reduced <- getSpartaFormat(Obs=Obs_reduced,focalSpecies=focalSpecies)
  bugs.data_reduced <- getBugsData(modelData=modelData_reduced)
  modelSummary_reduced <- runModel(bugs.data=bugs.data_reduced,
                                   modelData=modelData_reduced,
                                   focalSpecies,myModel)
  modelSummary_reduced$Type <- "Reduced"
  
  return(rbind(modelSummary,modelSummary_reduced))
  
}


```


(3) Effects of habitat degradation on effort ("car park")

(a) frequency of visits

```{r}

source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/scenario_frequencyvisits.R')

#sites vary in quality
#low quality site decline more (year effect is negative, interaction effect is positive)
#(1) fewer visits in low quality sites
#(2) number of visits declines over time in low quality sites

#assume probability of NA in any visit decreases with increasing habitat quality

#Assume species not reported second time it is seen
runSims <- function(siteEffect=1.5){
  Occ <- getOccuHistory(OccProb, spatialbeta=Seffects, interactionbeta=Ieffects, spatialcovariates=Scovariate,temporalbeta=Teffects, temporalcovariates=Tcovariate)
  Obs <- getRepeatVisits(Occ, NVisits, DetProb, SiteDetEffects,YearDetEffects,IntDetEffects, Scovariate,Tcovariate)
 
  Obs_reduced <- applyReducedVisits(Obs,prVisit=0.5,siteEffect,Scovariate)
  
  #with original dataset
  modelData <- getSpartaFormat(Obs,focalSpecies=focalSpecies)
  bugs.data <- getBugsData(modelData)
  modelSummary <- runModel(bugs.data,modelData,focalSpecies)
  modelSummary$Type <- "Standard"
  
  #with fixed dataset
  modelData_reduced <- getSpartaFormat(Obs=Obs_reduced,focalSpecies=focalSpecies)
  bugs.data_reduced <- getBugsData(modelData=modelData_reduced)
  modelSummary_reduced <- runModel(bugs.data=bugs.data_reduced,modelData=modelData_reduced,focalSpecies)
  modelSummary_reduced$Type <- "Reduced"
  
  return(rbind(modelSummary,modelSummary_reduced))
}


```

(b) length of visits (Detection probability)

```{r}


```


(4) scenario species number

(a) regional speciesl pool

```{r}
#Simulate the occurrences

runSims <- function(n=30){
  
NSpecies <- n
 Occ <- getOccuHistory(occProb = OccProb, spatialbeta=Seffects, interactionbeta=Ieffects, spatialcovariates=Scovariate,temporalbeta=Teffects, temporalcovariates=Tcovariate)
  Obs <- getRepeatVisits(Occ=Occ, NVisits=NVisits, DetProb = DetProb, SiteDetEffects,YearDetEffects,IntDetEffects, Scovariate,Tcovariate)
 
  modelData <- getSpartaFormat(Obs,focalSpecies=focalSpecies,subsetPositive = TRUE)
  bugs.data <- getBugsData(modelData)
  modelSummary <- runModel(bugs.data,modelData,focalSpecies)
  modelSummary$Type <- NSpecies
  
  return(modelSummary)
}

```

Replicate

```{r}

library(plyr)
out <- llply(c(5,10,20,40,80),function(x)replicate(5,runSims(n=x),simplify=FALSE))
out <- do.call(rbind,out)
getModelSummaries(out)
 
```

without subsetting to positive

```{r}
#Simulate the occurrences

runSims <- function(n=30){
  
NSpecies <- n
 Occ <- getOccuHistory(occProb = OccProb, spatialbeta=Seffects, interactionbeta=Ieffects, spatialcovariates=Scovariate,temporalbeta=Teffects, temporalcovariates=Tcovariate)
  Obs <- getRepeatVisits(Occ=Occ, NVisits=NVisits, DetProb = DetProb, SiteDetEffects,YearDetEffects,IntDetEffects, Scovariate,Tcovariate)
 
  modelData <- getSpartaFormat(Obs,focalSpecies=focalSpecies,subsetPositive = FALSE)
  bugs.data <- getBugsData(modelData)
  modelSummary <- runModel(bugs.data,modelData,focalSpecies)
  modelSummary$Type <- NSpecies
  
  return(modelSummary)
}

```

Replicate

```{r}

library(plyr)
out <- llply(c(5,10,20,40,80),function(x)replicate(2,runSims(n=x),simplify=FALSE))
out <- do.call(rbind,out)
getModelSummaries(out)
 
```

(b) species pool of specialists

```{r}


```

