#---
title: "sims_workflow"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(boot)
library(ggplot2)

#poisson raw data
#calc prop change in proportion of sites

```

Get parameter file and time stamp

```{r}

rm(list=ls())

parameterDF <- read.csv("C:/Users/db40fysa/Desktop/parameters_moreRangeChangeSims.csv")
#parameteDF is a file with the list of the all the parameters and their values for each simulation run

#decie on which run
type = 2

systemTime <- gsub(" ","_", Sys.time(),fixed=TRUE)
systemTime <- gsub(":","-",systemTime)

```

Load in functions

```{r}

source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/getParams.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/getOccuHistory.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/getRepeatVisits.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/getSpartaFormat.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/getBugsData.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/runModel.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/helperFunctions.R')

```


Create some replicated worlds

```{r, echo=FALSE, results='hide'}

Obs <- replicate(10,getSims(mysimNu=type),simplify=FALSE)
getObsSummaries(Obs)
trueSummaries <- gettrueSummaries(combineObs(Obs))

```

Run the basic model

```{r, message=FALSE, warning=FALSE}

out<- lapply(Obs,function(x)getModels(x,type=type))
#save(out,file=paste0("output/out_",type,"_",systemTime,".RData"))

```

Compare real and predicted intercept (psi1) and slope (psi change from last to first)

```{r}

checkResults(out,Obs)

```

Get summaries over parameters, model types

```{r}

print(modelSummaries <- getModelSummaries(out))

```

Compare to the analysis of raw data

```{r, message=FALSE, warning=FALSE}

outRaw <- ldply(Obs,function(x)rawdataAnalysis(x))

#save(outRaw,file=paste0("output/outRaw_",type,"_",systemTime,".RData"))
rawSummaries <- getrawSummaries(outRaw)

```

plot comparison
```{r}

plotComparison(modelSummaries,rawSummaries,trueSummaries)
#500/250

```

plot comparison of differences
```{r}
plotDifference(Obs,out,outRaw)

```

power analysis

```{r}

plotSE(out,outRaw)

```


Later comparison
```{r}

type <- 17

#load outputs
files <- list.files("output/")
setwd("output")
load(files[grepl(paste("out",type,sep="_"),files)])
load(files[grepl(paste("outRaw",type,sep="_"),files)])

#summarise
modelSummaries <- getModelSummaries(out)
rawSummaries <- getrawSummaries(outRaw)

#plot
plotComparison(modelSummaries,rawSummaries)
plotDifference(out,outRaw)

```



Atlas scenarios

(a) Scenario_autocorrelation - probability of dependence between sequential visits
- at a proportion of sites
- autocorrelation of order 1 with certain probability

```{r}

source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/scenario_autocorrelation.R')

runSims <- function(propSites=0.5,autoProb=0.5){
  
  #get simulated data
  Obs <- getSims()
  
  #reduce visits in non-atlas years
  Obs_auto <-applyAutocorrelation(Obs,propSites,autoProb)
  
  return(Obs_auto)
  
}

Obs <- replicate(100,runSims(),simplify=FALSE)

#raw data analysis
outRaw<- ldply(Obs,function(x)rawdataAnalysis(x))
rawSummaries <- getrawSummaries(outRaw)

#fit OD models
modelSummary_auto <- lapply(Obs,function(x)getModels(x,type="Autocorrelation",myModel))
modelSummaries <- getModelSummaries(modelSummary_auto)

#Analyse results
plotComparison(modelSummaries,rawSummaries)

```



(b) Pulse in recording - increased visits in one year (atlas year) 

```{r}

source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/scenario_pulsedvisits.R')

runSims <- function(nStandardVisits=5,atlasVisits=10){
  
  #get simulated data
  NVisits=atlasVisits
  Obs <- getSims()
  
  #reduce visits in non-atlas years
  Obs_pulsed <- pulsedVisits(Obs,nStandardVisits)

  #return summary data
  return(Obs_pulsed)
}

Obs <- replicate(100,runSims(),simplify=FALSE)

#raw data analysis
outRaw<- ldply(Obs,function(x)rawdataAnalysis(x))
rawSummaries <- getrawSummaries(outRaw)

#fit OD models
modelSummary_pulsed <- lapply(Obs,function(x)getModels(x,type="Pulsed",myModel))
modelSummaries <- getModelSummaries(modelSummary_pulsed)

#Analyse results
plotComparison(modelSummaries,rawSummaries)


```

(c) Lower quality grid cells less likely to be visited outside of atlas years

```{r}

source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/scenario_pulsedvisits.R')

runSims <- function(lowProb=0.25){

  #get simulated data
  Obs <- getSims()
  
  #reduce visits in non-atlas years
  Obs_spread <- pulsedSpreadVisits(Obs,SCovariate,lowProb)

  #return summary data
  return(Obs_spread)
}

Obs <- replicate(100,runSims(),simplify=FALSE)

#raw data analysis
outRaw<- ldply(Obs,function(x)rawdataAnalysis(x))
rawSummaries <- getrawSummaries(outRaw)

#fit OD models
modelSummary_spread <- lapply(Obs,function(x)getModels(x,type="Spread",myModel))
modelSummaries <- getModelSummaries(modelSummary_spread)

#Analyse results
plotComparison(modelSummaries,rawSummaries)

```

(2) Mismatch between scale of dynamics and observation

```{r}
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/scenario_spatialmismatch.R')

runSims <- function(x){
   Occ <- getOccuHistory(OccProb, spatialbeta=Seffects, interactionbeta=Ieffects, spatialcovariates=Scovariate,temporalbeta=Teffects, temporalcovariates=Tcovariate)
  Obs <- getRepeatVisits(Occ, NVisits, DetProb, SiteDetEffects,YearDetEffects,IntDetEffects, Scovariate,Tcovariate)
 
 
  #apply scenario
 Obs_grouped <- groupSite(NSites=NSites, Obs=Obs)
 Obs_reduced <- reduceVisits(Obs=Obs_grouped)
  
  #with original dataset
  modelData <- getSpartaFormat(Obs,focalSpecies=focalSpecies)
  bugs.data <- getBugsData(modelData)
  modelSummary <- runModel(bugs.data,modelData,focalSpecies)
  modelSummary$Type <- "Standard"
  
  #with fixed dataset
  #modelData_grouped <- getSpartaFormat(Obs=Obs_grouped,focalSpecies=focalSpecies)
  #bugs.data_grouped <- getBugsData(modelData=modelData_grouped)
  #modelSummary_grouped <- runModel(bugs.data=bugs.data_grouped,modelData=modelData_grouped,focalSpecies)
  #modelSummary_grouped$Type <- "grouped"
  
  #with fixed dataset
  modelData_reduced <- getSpartaFormat(Obs=Obs_reduced,focalSpecies=focalSpecies)
  bugs.data_reduced <- getBugsData(modelData=modelData_reduced)
  modelSummary_reduced <- runModel(bugs.data=bugs.data_reduced,
                                   modelData=modelData_reduced,
                                   focalSpecies,myModel)
  modelSummary_reduced$Type <- "Reduced"
  
  return(rbind(modelSummary,modelSummary_reduced))
  
}


```


(3) Effects of habitat degradation on effort ("car park")

(a) frequency of visits

```{r}

source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/scenario_frequencyvisits.R')

#sites vary in quality
#low quality site decline more (year effect is negative, interaction effect is positive)
#(1) fewer visits in low quality sites
#(2) number of visits declines over time in low quality sites

#assume probability of NA in any visit decreases with increasing habitat quality

#Assume species not reported second time it is seen
runSims <- function(siteEffect=1.5){
  Occ <- getOccuHistory(OccProb, spatialbeta=Seffects, interactionbeta=Ieffects, spatialcovariates=Scovariate,temporalbeta=Teffects, temporalcovariates=Tcovariate)
  Obs <- getRepeatVisits(Occ, NVisits, DetProb, SiteDetEffects,YearDetEffects,IntDetEffects, Scovariate,Tcovariate)
 
  Obs_reduced <- applyReducedVisits(Obs,prVisit=0.5,siteEffect,Scovariate)
  
  #with original dataset
  modelData <- getSpartaFormat(Obs,focalSpecies=focalSpecies)
  bugs.data <- getBugsData(modelData)
  modelSummary <- runModel(bugs.data,modelData,focalSpecies)
  modelSummary$Type <- "Standard"
  
  #with fixed dataset
  modelData_reduced <- getSpartaFormat(Obs=Obs_reduced,focalSpecies=focalSpecies)
  bugs.data_reduced <- getBugsData(modelData=modelData_reduced)
  modelSummary_reduced <- runModel(bugs.data=bugs.data_reduced,modelData=modelData_reduced,focalSpecies)
  modelSummary_reduced$Type <- "Reduced"
  
  return(rbind(modelSummary,modelSummary_reduced))
}


```

(b) length of visits (Detection probability)

```{r}


```


(4) scenario species number

(a) regional speciesl pool

```{r}
#Simulate the occurrences

runSims <- function(n=30){
  
NSpecies <- n
 Occ <- getOccuHistory(occProb = OccProb, spatialbeta=Seffects, interactionbeta=Ieffects, spatialcovariates=Scovariate,temporalbeta=Teffects, temporalcovariates=Tcovariate)
  Obs <- getRepeatVisits(Occ=Occ, NVisits=NVisits, DetProb = DetProb, SiteDetEffects,YearDetEffects,IntDetEffects, Scovariate,Tcovariate)
 
  modelData <- getSpartaFormat(Obs,focalSpecies=focalSpecies,subsetPositive = TRUE)
  bugs.data <- getBugsData(modelData)
  modelSummary <- runModel(bugs.data,modelData,focalSpecies)
  modelSummary$Type <- NSpecies
  
  return(modelSummary)
}

```

Replicate

```{r}

library(plyr)
out <- llply(c(5,10,20,40,80),function(x)replicate(5,runSims(n=x),simplify=FALSE))
out <- do.call(rbind,out)
getModelSummaries(out)
 
```

without subsetting to positive

```{r}
#Simulate the occurrences

runSims <- function(n=30){
  
NSpecies <- n
 Occ <- getOccuHistory(occProb = OccProb, spatialbeta=Seffects, interactionbeta=Ieffects, spatialcovariates=Scovariate,temporalbeta=Teffects, temporalcovariates=Tcovariate)
  Obs <- getRepeatVisits(Occ=Occ, NVisits=NVisits, DetProb = DetProb, SiteDetEffects,YearDetEffects,IntDetEffects, Scovariate,Tcovariate)
 
  modelData <- getSpartaFormat(Obs,focalSpecies=focalSpecies,subsetPositive = FALSE)
  bugs.data <- getBugsData(modelData)
  modelSummary <- runModel(bugs.data,modelData,focalSpecies)
  modelSummary$Type <- NSpecies
  
  return(modelSummary)
}

```

Replicate

```{r}

library(plyr)
out <- llply(c(5,10,20,40,80),function(x)replicate(2,runSims(n=x),simplify=FALSE))
out <- do.call(rbind,out)
getModelSummaries(out)
 
```

(b) species pool of specialists

```{r}


```

