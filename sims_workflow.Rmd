---
title: "sims_workflow"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Define basic scenario set-up

```{r}

#Number of sites in the landscape
NSites <- 8

#Number of species in the regional pool
NSpecies <- 4

#Number of visits to each site within each year
NVisits <- 4

#Define average habitat quality of each site
Q_covariate <- rnorm(NSites)

#Define average occupancy of species
OccProb <- rep(0.5,NSpecies)

#Define quality effects
Q_effects <- rep(0,NSpecies)

#Define average detection probability
DetProb <- 0.5

```

Simulate the occurences

```{r}
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/getOccuHistory.R')

Occ <- getOccuHistory(occProb = OccProb, beta=Q_effects, covariates=Q_covariate)

```

Simulate the detection process at repeat visits

```{r}
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/getRepeatVisits.R')
Obs <- getRepeatVisits(nVisits=5, PrObs = DetProb)

```


Plot detection history

```{r}
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/PlotHistory.R')
plotHistory(Obs)

```


Format data for bugs model
```{r}

getBugsData <- function(Obs){
  bugs.data = list(y = Obs$obs,
                   nsite = length(unique(Obs$Site)),
                   nvisit = length(unique(Obs$Visit)),
                   Site = Obs$Site)
  
  return(bugs.data)  
}

bugs.data <- getBugsData(subset(Obs,Species==1))

```

Run model

```{r}
#fit model
library(rjags)
library(R2WinBUGS)
library(jagsUI)

#define model params
ni <- 6000   ;   nb <- 2000   ;   nt <- 5   ;   nc <- 3


#specify parameters to monitor
params <- c("prop.p","prop.o")

#run model
out <- jags(bugs.data, inits=NULL, params, "R/basicSim.txt", n.thin=nt,
            n.chains=nc, n.burnin=nb,n.iter=ni,parallel=T)

```

