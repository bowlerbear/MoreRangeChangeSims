---
title: "sims_workflow"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(boot)
```

Simulation parameters

```{r}
#Define basic scenario set-up

#Number of sites in the landscape
NSites <- 50

#Number of species in the regional pool
NSpecies <- 30

#Number of time points
NYears <- 10

#Define occupancy settings

#Define average occupancy of species
OccProb <- rep(0.5,NSpecies)

#Define average habitat quality of each site
Scovariate <- rnorm(NSites,0,1)

#Define spatial quality effects
Seffects <- rep(0.05,NSpecies)

#Define time trend
Tcovariate <- (1:NYears)-mean(1:NYears)

#Define spatial quality effects
Teffects <- rep(0.2,NSpecies)

#Interaction - between space and time
Ieffects <- rep(0,NSpecies)

#Define sampling effects:

#Number of visits to each site within each year
NVisits <- 5

#Define average detection probability
DetProb <- 0.75

#detection covariates
SiteDetEffects <- rep(0,NSpecies)
YearDetEffects <- rep(0,NSpecies)
IntDetEffects <- rep(0,NSpecies)

#Identify focal species
focalSpecies=1

```

Save the parameters and identify simulation run

```{r}

systemTime <- gsub(" ","_", Sys.time(),fixed=TRUE)
systemTime <- gsub(":","-",systemTime)

parameters <- list(DetProb,focalSpecies,Ieffects,IntDetEffects,NSites,
                  NSpecies,NVisits,NYears,OccProb,Scovariate,Seffects,SiteDetEffects,
                  Tcovariate,Teffects,YearDetEffects)

save(parameters,file=paste0("parameters/parameters",systemTime,".RData"))

```

Load in functions

```{r}

source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/getOccuHistory.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/getRepeatVisits.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/getSpartaFormat.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/getBugsData.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/runTrendModel.R')
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/helperFunctions.R')

```

Create some replicated worls

```{r, echo=FALSE, results='hide'}

Obs <- replicate(10,getSims(),simplify=FALSE)
getObsSummaries(Obs)

```

Run the basic model

```{r}

out<- lapply(Obs,function(x)getModels(x))
#save(out,file=paste0("output/out_standard",systemTime,".RData"))

```

Compare real and predicted intercept (psi1) and slope (psi change from last to first)

```{r}

allModels <- do.call(rbind,out)

ggplot(subset(allModels,Param=="first.psi"))+
  geom_point(aes(x=mean,y=truePsiFirst))

ggplot(subset(allModels,Param=="mean.psi.change"))+
  geom_point(aes(x=mean,y=truePsiChange))

ggplot(subset(allModels,Param=="odds.psi.change"))+
  geom_point(aes(x=mean,y=truePsiOdds))

#model does a great job

```

Get summaries over parameters, model types

```{r}

getModelSummaries(out)

```

Atlas scenarios

(a) Scenario_autocorrelation

```{r}

#50% of people(sites do this) behaviour - ask Klaus Jurgen Conze

source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/scenario_autocorrelation.R')

Obs_auto <- lapply(Obs,function(x)applyAutocorrelation(x,propSites=1))
getObsSummaries(Obs_auto)
out <- replicate(100,getModels(Obs_auto,type="Autocorrelated"),simplify=FALSE)
#save(out,file="output/out_scenario_autocorrelation.RData")

getModelSummaries(out)
plotSummaries(out)

Obs_fixed <- fixAutocorrelation(Obs_auto)
out <- replicate(100,getModels(Obs_fixed,type="Fixed"),simplify=FALSE)
#save(out,file="output/out_scenario_autocorrelation.RData")

getModelSummaries(out)
plotSummaries(out)

```

Detect issue

```{r}

Occ <- getOccuHistory(occProb = OccProb, spatialbeta=Seffects, interactionbeta=Ieffects, spatialcovariates=Scovariate,temporalbeta=Teffects, temporalcovariates=Tcovariate)
Obs <- getRepeatVisits(Occ=Occ, NVisits=NVisits, DetProb = DetProb, SiteDetEffects,YearDetEffects,IntDetEffects, Scovariate,Tcovariate)
Obs <- applyAutocorrelation(Obs)
modelData <- getSpartaFormat(Obs,focalSpecies=focalSpecies,subsetPositive = TRUE)
  

testAutocorrelation(modelData)
#test for trap shyness would be better

```


(b) including new grid cells (potentially lower quality) in atlas years

```{r}

source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/scenario_atlassites.R')

runSims <- function(nStandardSites=30,totalN=60){
  
NSites <- totalN # but all 60 only seen in one year
Scovariate <- rnorm(NSite)
      
  Occ <- getOccuHistory(occProb = OccProb, spatialbeta=Seffects, interactionbeta=Ieffects, spatialcovariates=Scovariate,temporalbeta=Teffects, temporalcovariates=Tcovariate)
  Obs <- getRepeatVisits(Occ=Occ, NVisits=NVisits, DetProb = DetProb, SiteDetEffects,YearDetEffects,IntDetEffects, Scovariate,Tcovariate)
 
  #apply scenario
  Obs_lesssites <- reduceSites(Obs,nStandardSites,samplingBias=TRUE)
  Obs_biasedsites <- reduceSites(Obs,nStandardSites,samplingBias=FALSE)
  
  #with original dataset
  modelData <- getSpartaFormat(Obs,focalSpecies=focalSpecies)
  bugs.data <- getBugsData(modelData)
  modelSummary <- runModel(bugs.data,modelData,focalSpecies)
  modelSummary$Type <- "Standard"
  
  #with reduced sampling at random
  modelData_lesssites <- getSpartaFormat(Obs=Obs_lesssites,focalSpecies=focalSpecies)
  bugs.data_lesssites <- getBugsData(modelData=modelData_lesssites)
  modelSummary_lesssites <- runModel(bugs.data=bugs.data_lesssites,modelData=modelData_lesssites,focalSpecies)
  modelSummarylesssites$Type <- "LessSites"
  
  #with reduced sampling at biased
  modelData_biasedsites <- getSpartaFormat(Obs=Obs_biasedsites,focalSpecies=focalSpecies)
  bugs.data_biasedsites <- getBugsData(modelData=modelData_biasedsites)
  modelSummary_biasedsites <- runModel(bugs.data=bugs.data_biasedsites,modelData=modelData_biasedsites,focalSpecies)
  modelSummarybiasedsites$Type <- "Biasedsites"
  
  
  return(rbind(modelSummary,modelSummary_lesssites,modelSummary_biasedsites))
}

```

(c) Pulse in recording - increased visits in one year - ** visible in the dragonfly data...

```{r}

source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/scenario_pulsedvisits.R')

runSims <- function(nStandardVisits=4,maxVisits=10){
  
NVisits <- maxVisits
      
  Occ <- getOccuHistory(occProb = OccProb, spatialbeta=Seffects, interactionbeta=Ieffects, spatialcovariates=Scovariate,temporalbeta=Teffects, temporalcovariates=Tcovariate)
  Obs <- getRepeatVisits(Occ=Occ, NVisits=NVisits, DetProb = DetProb, SiteDetEffects,YearDetEffects,IntDetEffects, Scovariate,Tcovariate)
 
  #apply scenario
  Obs_lessvisits <- pulsedVisits(Obs,nStandardVisits)
  
  #with original dataset
  modelData <- getSpartaFormat(Obs,focalSpecies=focalSpecies)
  bugs.data <- getBugsData(modelData)
  modelSummary <- runModel(bugs.data,modelData,focalSpecies)
  modelSummary$Type <- "Standard"
  
  #with pulsed visits in atlas year 
  modelData_lesssites <- getSpartaFormat(Obs=Obs_lesssites,focalSpecies=focalSpecies)
  bugs.data_lesssites <- getBugsData(modelData=modelData_lesssites)
  modelSummary_lesssites <- runModel(bugs.data=bugs.data_lesssites,modelData=modelData_lesssites,focalSpecies)
  modelSummarylesssites$Type <- "LessSites"
  
  return(rbind(modelSummary,modelSummary_lesssites))
}

```

(2) Mismatch between scale of dynamics and observation

```{r}
source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/scenario_spatialmismatch.R')

runSims <- function(x){
   Occ <- getOccuHistory(OccProb, spatialbeta=Seffects, interactionbeta=Ieffects, spatialcovariates=Scovariate,temporalbeta=Teffects, temporalcovariates=Tcovariate)
  Obs <- getRepeatVisits(Occ, NVisits, DetProb, SiteDetEffects,YearDetEffects,IntDetEffects, Scovariate,Tcovariate)
 
 
  #apply scenario
 Obs_grouped <- groupSite(NSites=NSites, Obs=Obs)
 Obs_reduced <- reduceVisits(Obs=Obs_grouped)
  
  #with original dataset
  modelData <- getSpartaFormat(Obs,focalSpecies=focalSpecies)
  bugs.data <- getBugsData(modelData)
  modelSummary <- runModel(bugs.data,modelData,focalSpecies)
  modelSummary$Type <- "Standard"
  
  #with fixed dataset
  #modelData_grouped <- getSpartaFormat(Obs=Obs_grouped,focalSpecies=focalSpecies)
  #bugs.data_grouped <- getBugsData(modelData=modelData_grouped)
  #modelSummary_grouped <- runModel(bugs.data=bugs.data_grouped,modelData=modelData_grouped,focalSpecies)
  #modelSummary_grouped$Type <- "grouped"
  
  #with fixed dataset
  modelData_reduced <- getSpartaFormat(Obs=Obs_reduced,focalSpecies=focalSpecies)
  bugs.data_reduced <- getBugsData(modelData=modelData_reduced)
  modelSummary_reduced <- runModel(bugs.data=bugs.data_reduced,modelData=modelData_reduced,focalSpecies)
  modelSummary_reduced$Type <- "Reduced"
  
  return(rbind(modelSummary,modelSummary_reduced))
}


```

Replicate the simulation

```{r, echo=FALSE, results='hide'}

out <- replicate(2,runSims(),simplify=FALSE)

getModelSummaries(out)

```

(3) Effects of habitat degradation on effort ("car park")

(a) frequency of visits

```{r}

source('C:/Users/db40fysa/Nextcloud/sMon-Analyses/MoreRangeChangeSims/R/scenario_frequencyvisits.R')

#sites vary in quality
#low quality site decline more (year effect is negative, interaction effect is positive)
#(1) fewer visits in low quality sites
#(2) number of visits declines over time in low quality sites

#assume probability of NA in any visit decreases with increasing habitat quality

#Assume species not reported second time it is seen
runSims <- function(siteEffect=1.5){
  Occ <- getOccuHistory(OccProb, spatialbeta=Seffects, interactionbeta=Ieffects, spatialcovariates=Scovariate,temporalbeta=Teffects, temporalcovariates=Tcovariate)
  Obs <- getRepeatVisits(Occ, NVisits, DetProb, SiteDetEffects,YearDetEffects,IntDetEffects, Scovariate,Tcovariate)
 
  Obs_reduced <- applyReducedVisits(Obs,prVisit=0.5,siteEffect,Scovariate)
  
  #with original dataset
  modelData <- getSpartaFormat(Obs,focalSpecies=focalSpecies)
  bugs.data <- getBugsData(modelData)
  modelSummary <- runModel(bugs.data,modelData,focalSpecies)
  modelSummary$Type <- "Standard"
  
  #with fixed dataset
  modelData_reduced <- getSpartaFormat(Obs=Obs_reduced,focalSpecies=focalSpecies)
  bugs.data_reduced <- getBugsData(modelData=modelData_reduced)
  modelSummary_reduced <- runModel(bugs.data=bugs.data_reduced,modelData=modelData_reduced,focalSpecies)
  modelSummary_reduced$Type <- "Reduced"
  
  return(rbind(modelSummary,modelSummary_reduced))
}


```

Replicate

```{r}

library(plyr)
out <- llply(c(0.1,0.5,1,1.5,2),function(x)replicate(2,runSims(siteEffect=x),simplify=FALSE))
out <- do.call(rbind,out)
getModelSummaries(out)
 
```

(b) Detection probability

```{r}


```


(4) scenario species number

(a) regional speciesl pool

```{r}
#Simulate the occurrences

runSims <- function(n=30){
  
NSpecies <- n
 Occ <- getOccuHistory(occProb = OccProb, spatialbeta=Seffects, interactionbeta=Ieffects, spatialcovariates=Scovariate,temporalbeta=Teffects, temporalcovariates=Tcovariate)
  Obs <- getRepeatVisits(Occ=Occ, NVisits=NVisits, DetProb = DetProb, SiteDetEffects,YearDetEffects,IntDetEffects, Scovariate,Tcovariate)
 
  modelData <- getSpartaFormat(Obs,focalSpecies=focalSpecies,subsetPositive = TRUE)
  bugs.data <- getBugsData(modelData)
  modelSummary <- runModel(bugs.data,modelData,focalSpecies)
  modelSummary$Type <- NSpecies
  
  return(modelSummary)
}

```

Replicate

```{r}

library(plyr)
out <- llply(c(5,10,20,40,80),function(x)replicate(5,runSims(n=x),simplify=FALSE))
out <- do.call(rbind,out)
getModelSummaries(out)
 
```

without subsetting to positive

```{r}
#Simulate the occurrences

runSims <- function(n=30){
  
NSpecies <- n
 Occ <- getOccuHistory(occProb = OccProb, spatialbeta=Seffects, interactionbeta=Ieffects, spatialcovariates=Scovariate,temporalbeta=Teffects, temporalcovariates=Tcovariate)
  Obs <- getRepeatVisits(Occ=Occ, NVisits=NVisits, DetProb = DetProb, SiteDetEffects,YearDetEffects,IntDetEffects, Scovariate,Tcovariate)
 
  modelData <- getSpartaFormat(Obs,focalSpecies=focalSpecies,subsetPositive = FALSE)
  bugs.data <- getBugsData(modelData)
  modelSummary <- runModel(bugs.data,modelData,focalSpecies)
  modelSummary$Type <- NSpecies
  
  return(modelSummary)
}

```

Replicate

```{r}

library(plyr)
out <- llply(c(5,10,20,40,80),function(x)replicate(2,runSims(n=x),simplify=FALSE))
out <- do.call(rbind,out)
getModelSummaries(out)
 
```

(b) species pool of specialists

```{r}


```

